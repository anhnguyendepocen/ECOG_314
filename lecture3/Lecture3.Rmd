---
title: "Exploring Data"
author: "Damian Thomas"
date: "2016-09-16"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Welcome & Setup

1. Log in to network 
2. Update course materials from github 
3. Open lecture file
4. Set working directory

***
## Quick Assessment

What have data analysis software have students used in the past?

* Stata
* SAS
* Excel
* SPSS
* Matlab
* Other

Compare to the [broader trends](http://r4stats.com/articles/popularity/)

***
## Homework Feedback

***
## Refereshers

### Rstudio -- Four Panels and a Menu 

The windows in the default layout can be broken down into two broad categories, according to their purpose. 

1. Inputs from user 
    * Console: interactive R prompt 
    * Text Editor: view, create, and change contents of text files 
2. Outputs from R 
    * Console: interactive R prompt 
    * Environment: current workspace, previous commands 
    * Viewer: View plots, help documentation, etc. 


### R Object types

* Vectors: one dimension, one type 
* Lists: one dimension, many types 
* Matrices: two dimensions, one type 
* Data Frames: two dimensions, many types 

### R syntax

* Objects: store information 
* Functions: input and output objects, take parameters 
* Everything is an object or a function, unless it's an environment  ([what's an environment?](https://www.r-bloggers.com/what-is-an-r-environment/)) 

Subset objects by indexing: "[", "[[", or "$" -- mnemonics:

* "x[7]", equivalent to $x_{7}$, "7***th*** element from vector x"
* "X[4,5]", equivalent to $X_{4,5}$, "4***th*** row, 5***th*** column from matrix X"
* "student[[GPA]]", equivalent to the "GPA ***of*** student"
* "student[[3]]", equivalent to the "3rd part ***of*** student"
* "student$GPA", equivalent to "student***'s*** GPA" 

Do things with objects using functions

* f(x), just like $f(x)$, returns the value of "f evaluated at x"


### Reading Data

* Delimited text files (CSV, tab, text, etc): use base R functions, or functions from the readr package 
* Excel, stata, etc.: use packages (foreign, etc.) 
* unstructured data: 

### Viewing Data

* Environment tab: click on the object 
* print() function: type the object name at command prompt and press enter 
* View() function: in RStudio 


### Running Code 

*TMTOWTDI: "There's more than one way to do it"*

1. One line of code 
    a. Console: type the command, press enter 
    b. Editor: 
        * select the text, then click **Run** 
        * select the text, then press **Ctrl+Enter** 
        * place the cursor on the line of code, then press **Ctrl+Enter**  
2. Multiple lines of code 
     a. Console: type commands separated by semicolons, press enter 
     b. RStudio Editor: 
          * select the text, then click **Run** 
          * select the text, then press **Ctrl+Enter** 
          
3. Entire program 
     a. Console: use the **source()** function to execute commands saved in a file 
     b. RStudio Editor: 
          * open the file, then press **Ctrl+Shift+Enter** 
          * open the file, then press the **Source** button 
     c. Batch Mode (outside of RStudio) 
          * go to system command prompt, then execute the command: **R CMD BATCH filename.R** 

4. Markdown documents (e.g., lecture2.Rmd) open the file and press the **Knit HTML** button. 


    
### Managing your Rstudio session 

* Save workspace: write objects in memory to a file 
    a. go to the **Environment** tab, then click on the blue disk icon 
    b. go the **Session** menu, select **Save Workspace As** 
    c. use the **save()** function 
    
* Clear workspace: remove objects from memory 
    a. go to the **Environment** tab, then click on the yellow broom icon 
    b. go the **Session** menu, select **Load Workspace** 
    c. use the **ls()** and **rm()** functions  

* Reload saved workspace, or read objects that were saved to a file 
    a. go to the **Environment** tab, then click on the yellow and green folder icon 
    b. go the **Session** menu, select **Load Workspace** 
    c. use the **load()** function 
    
* Customize Appearance: go to **Tools** menu, then select **Global Options**, then choose **Appearance** (the paint bucket icon).  From there you can choose a color theme for syntax highlighting and change the default font size. Other part of menu disable automatic quote matching, etc.

* Set working directory

***

## Exploring Data 

Data sets fall into 3 major catgories: time-series, cross-sectional, and panel or longitudinal.


### Time series Data

A single measure observed at different points in time. 

"Most commonly, a ***time series*** is a sequence taken at successive equally spaced points in time. Thus it is a sequence of discrete-time data. Examples of time series are heights of ocean tides, counts of sunspots, and the daily closing value of the Dow Jones Industrial Average" ([Wikipedia, 2016-03-30](https://en.wikipedia.org/wiki/Time_series))

Examples: Unemployment rate, GDP, my height

### Step 1 - Get raw data from the source

The St. Louis Fed provides thousands of time series to the public ([https://fred.stlouisfed.org/](https://fred.stlouisfed.org/)). 

* Choose an example and download it as a csv file.  
* Advanced option: use the quantmod package to download directly from R 

```{r download_time_series}
# install.packages(quantmod)
# if ( !file.exists() ) download.file()
```

### Step 2 - Look at the raw data file

* In RStudio, view the raw data. 
    1. go the the **Files** tab (lower right) 
    2. Navigate to the directory where you saved the file  
    3. click on the file to view 

* Notice: the dot "." indicates missing values 

### Step 3 - Read the raw data into R

```{r read_time_series_data file}
# base R function
hhnw <- read.csv("data/TNWBSHNO.csv")
```
Now what?

### Step 4 - Look at the raw data again (in R)

* Browse the data frame in Rstudio -- click on the object name (in the Environment tab) 
* Use R commands to print information about the data frame 

```{r look_at_time_series_1}
# View data "structure""
str(hhnw)

# Print the first few rows of data
head(hhnw)

# And, print the last few rows of data
tail(hhnw)

# maybe even print 5 random rows of data
hhnw[sample(1:nrow(hhnw), 5),]
```

From these commands we know a little bit about how the data

* Variable names 
* Number of observations 
* Data types 
* The first few values 
* There are missing values, indicated by the dot "." 

### Step 5 - Data Cleaning

Problems

 
1. We have missing values 
2. Variable names:  (a) in all caps, (b) not very informative
3. Default data types and units don't make sense 

Fixes

1. Use options to tell read.csv()
2. Rename variables 
3. Transform the data

```{r convert_strings_to_dates}
# start over
rm(hhnw)

# Read the raw file
hhnw <- read.csv("data/TNWBSHNO.csv", na.strings=".", stringsAsFactors = FALSE)

# Change names
names(hhnw) <- c("date", "level")

# Convert the character type into a date type
hhnw$date <- as.Date(hhnw$date, format="%Y-%m-%d")

# Convert millions to billions
hhnw$level <- round(hhnw$level / 1000, digits = 1)

# Look at the data
str(hhnw)
head(hhnw)
tail(hhnw)
```

Better?

### Step 6 - Numeric summaries

Introducing the base R functions 

* summary()
* min() 
* max()
* mean() 
* var() 
* sd() 
* quantile() 
* median()

```{r summary_function1}
# The easy way - tell me about this data frame
summary(hhnw)
```

```{r summary_function2}
# summary of household net worth's level measure (only)
summary(hhnw$level)  
```

```{r ts_summary_functions}
# DIY summary statistics
mean(hhnw$level, na.rm=TRUE)
max(hhnw$level, na.rm=TRUE)
quantile(hhnw$level, na.rm=TRUE)
quantile(hhnw$level, probs=c(0.10, 0.90), na.rm=TRUE)
sd(hhnw$level, na.rm=TRUE)
```


Data manipulation 

* subset()
* merge()


```{r summary_on_subset}
# Create subsets of the data frame 
pre_crisis <- subset(hhnw, hhnw$date < as.Date("2007-06-01"))

summary(pre_crisis)

post_crisis <- subset(hhnw, hhnw$date >= as.Date("2007-06-01"))

summary(post_crisis)
```



### Step 6 - Visual presentation

* Line graph  
* Histogram 
* Boxplot  

```{r plot_time_series}
# Visualize every observation in the time series with a line plot
plot(hhnw$date, hhnw$level, type = "l") 

# viualize distribution with histogram
hist(hhnw$level)

# visualize distribution with boxplot
boxplot(hhnw$level)

# compare subsets with side-by-sde plots
boxplot(pre_crisis$level, main = "Pre Crisis")
boxplot(post_crisis$level, main = "Post Crisis")
```

* advanced option:

```{r plot_time_series2}
# compare subsets with side-by-sde plots
par(mfrow=c(1,2))
boxplot(pre_crisis$level, main = "Pre Crisis")
boxplot(post_crisis$level, main = "Post Crisis")
```

* Good enough? We can do better.  
* Clear workspace.

### More Data Cleaning

Addtional problems

1. limited information from single time series
    a. the level measure only: no flows, growth rates, etc.
    b. important dates are not clearly marked  
2. creating a new data frame for every subset can be unweildy  
3. Shortcut for readable dates would be nice 

Fixes

1. Compute new variables, and add more data to the data frame  
    a. flow measure: $\textrm{flow}_t = \textrm{level}_{t} - \textrm{level}_{t-1}$  
    b. growth rate: $\textrm{growth}_t = 100 * \textrm{flow}_{t} \textrm{level}_{t-1}$   
2. categorize or label each observation --  identify recession periods 
3. create alternative dates  

First, get more data. Download recession data from [FRED](https://fred.stlouisfed.org/release?rid=242)): [NBER based Recession Indicators for the United States from the Period following the Peak through the Trough](https://fred.stlouisfed.org/series/USRECQ)

We will also need a function to compute lags in a data frame. A brief digression:

```{r define_shift}
# R functions are objects that contain instructions

prior_value <- function(x, k=1) {
    x <- c(rep(NA, k), head(x, -k))
    return(x)
}

next_value <- function(x, k=1) {
    x <- c(tail(x, -k), rep(NA, k))
    return(x)
}

# Test with simple sequece
foo <- 1:10

prior_value(foo) # lag

next_value(foo) # lead

foo - prior_value(foo) # compute change
```


Rebuild our data set with the new components

```{r remake_ts_dataframe}

# Read the raw file
hhnw <- read.csv("data/TNWBSHNO.csv", na.strings=".", stringsAsFactors = FALSE)

# Change names
names(hhnw) <- c("date", "level")

# Convert the character type into a date type
hhnw$date <- as.Date(hhnw$date, format="%Y-%m-%d")

# Create a simple time index
hhnw$t <- seq(1, nrow(hhnw))

# Label quarters
hhnw$q <- ceiling(as.integer(format(hhnw$date, "%m")) / 3)

hhnw$quarter <- paste(format(hhnw$date, "%Y"), hhnw$q, sep=":Q")

# Convert millions to billions
hhnw$level <- round(hhnw$level / 1000, digits = 1)

# compute the flow (change in level)
hhnw$flow <- hhnw$level - prior_value(hhnw$level)

# compute the growth rate (one quarter trend)
hhnw$growth <- 100 * ( hhnw$flow ) / prior_value(hhnw$level) 
```

Merge in recession indicator

```{r merge_tz}
# After inpecting the raw data, read it into R
# use ?read.csv command to view explanation of these parameters
cycle <- read.csv("data/USRECQ.csv", col.names=c("date", "recession"), colClasses = c("Date", "integer"), stringsAsFactors = FALSE)

# Merge the two data sets
hhnw <- merge(hhnw, cycle, by = "date", all.x = TRUE)

# Fill in missing values with zero
hhnw$recession <- ifelse(is.na(hhnw$recession), 0, hhnw$recession)

# Look at the data (again)
str(hhnw)
head(hhnw)
tail(hhnw)
```

```{r replot_ts}
plot(hhnw$date, hhnw$level, main = "Household Net Worth, Level")
plot(hhnw$date, hhnw$flow, main = "Household Net Worth, Flow")
plot(hhnw$date, hhnw$growth, main = "Household Net Worth, Growth Rate")

plot(hhnw$q, hhnw$flow, main="Household Net Worth: Flows by Quarter")


par(mfrow=c(1,2))
boxplot(hhnw[ hhnw$recession==1,  "level"], main = "Household Net Worth: Growth Rate During Recessions")

boxplot(hhnw[ hhnw$recession==0,  "level"], main = "Household Net Worth: Growth Rate During Expansions")

```


#### Exercises: Answer specific questions about the data

* what is the all time high, when did it occur? 
* what was the previous high, and when did it occur? 
* compare the period before and after the crisis 
    a. max values 
    b. min values 
    c. interquartile range 
    d. trend 
    e. mean 
    f. standard deviation 

```{r answer_time_series_qs}
#...
```
     

### Cross Sectional Data

A single measure (or set of measures) observed from multiple entities at the same point in time.

"Cross-sectional data, or a cross section of a study population, in statistics and econometrics is a type of data collected by observing many subjects (such as individuals, firms, countries, or regions) at the same point of time, or without regard to differences in time. Analysis of cross-sectional data usually consists of comparing the differences among the subjects." ([Wikipedia, 2016-03-30](https://en.wikipedia.org/wiki/Cross-sectional_data))

Examples: student GPAs, 

### Panel Data

Cross sectional data from multiple points in time

"In statistics and econometrics, the term panel data refers to multi-dimensional data frequently involving measurements over time. Panel data contain observations of multiple phenomena obtained over multiple time periods for the same firms or individuals. In biostatistics, the term longitudinal data is often used instead, wherein a subject or cluster constitutes a panel member or individual in a longitudinal study. Time series and cross-sectional data can be thought of as special cases of panel data that are in one dimension only (one panel member or individual for the former, one time point for the latter)." ([Wikipedia, 2016-03-30](https://en.wikipedia.org/wiki/Panel_data))

* PSID, US Census, ...



***

## Resources

https://www.rstudio.com/online-learning/#R

http://tryr.codeschool.com/

https://github.com/DataScienceSpecialization/courses/tree/master/04_ExploratoryAnalysis

http://r4ds.had.co.nz/

https://github.com/hadley/r4ds


"R is a language, spoken to computers and other programmers"